<script>
new Vue({
  el: '#jobForm',
  data: function() {
    return { 
      record: <%= @record.to_hash.to_json %>,
      job: null,
      showJobTemplates: true,
      jobTemplates: [],
      showDevices: false,
      deviceCheckedList: [],
      devices: [],
      showApps: false,
      apps: [],
      app: null,
      showVersions: false,
      versions: [],
      version: null,
      latest_version: null
    }
  },
  created() {
    this.listJobTemplates(0)
  },
  watch: {
    deviceCheckedList(now, old) {
      console.log('deviceCheckedList:', now)
      let deviceList = [], 
          deviceNames = [];

      now.forEach((item) => {
        deviceList.push({name: item.human_name, uuid: item.uuid})
        deviceNames.push('<' + item.human_name + '>')
      })
      this.record.device_name = deviceNames.join(',')
      this.record.device_list = JSON.stringify(deviceList)
    }
  },
  methods: {
    checkForm(el) {
      console.log(el)
      let isOk = false
      if(!this.record.title) {
        window.Loading.popup('请选择模板')
      } else if(!this.record.device_list) {
        window.Loading.popup('请选择设备')
      } else if(!this.record.command) {
        window.Loading.popup('请选择有效模板')
      } else {
        isOk = true
      }

      if(isOk) {
        return true
      } else {
        el.preventDefault();
      }
    },
    jobTemplateRadioClick(item) {
      let content = item.content
      if(item.content && item.content.length) {
        command = item.content.split("\n").map(function(el) {
          return $.trim(el);
        }).join("\n");
      }

      this.record.title = item.title
      this.record.command = content
      this.renderCommand(false)
    },
    listJobTemplates(page) {
      let that = this
      that.showJobTemplates = true
      that.showDevices = false
      that.showApps = false
      that.showVersions = false

      window.Loading.show('获取数据中...')
      $.ajax({
        method: 'get',
        url: '/api/v1/job_templates',
        contentType: 'application/json',
        data: {page: page, page_size: 100}
      }).done(function(res, status, xhr) {
        that.jobTemplates = res.data
      }).fail(function(res, status, xhr) {
      }).always(function(res, status, xhr) {
        window.Loading.hide()
      });
    },
    listDevices(page) {
      let that = this
      that.showJobTemplates = false
      that.showDevices = true
      that.showApps = false
      that.showVersions = false

      window.Loading.show('获取数据中...')
      $.ajax({
        method: 'get',
        url: '/api/v1/devices',
        contentType: 'application/json',
        data: {page: page, page_size: 100}
      }).done(function(res, status, xhr) {
        that.devices = res.data
      }).fail(function(res, status, xhr) {
      }).always(function(res, status, xhr) {
        window.Loading.hide()
      });
    },
    appRadioClick(item) {
      this.app = item
      this.record.app_id = item.id
      this.record.app_name = item.name
      this.record.app_uuid = item.uuid
      this.renderCommand(false)
    },
    listApps(page) {
      let that = this
      that.showJobTemplates = false
      that.showDevices = false
      that.showApps = true
      that.showVersions = false

      window.Loading.show('获取数据中...')
      $.ajax({
        method: 'get',
        url: '/api/v1/apps',
        contentType: 'application/json',
        data: {page: page, page_size: 100}
      }).done(function(res, status, xhr) {
        that.apps = res.data
      }).fail(function(res, status, xhr) {
      }).always(function(res, status, xhr) {
        window.Loading.hide()
      });
    },
    versionRadioClick(item) {
      this.version = item
      this.record.version_id = item.id
      this.record.version_name = item.version
      this.renderCommand(false)
    },
    listVersions(page) {
      if(!this.record.app_id) {
        window.Loading.popup("请选择应用")
        return false;
      }

      let that = this
      that.showJobTemplates = false
      that.showDevices = false
      that.showApps = false
      that.showVersions = true
      window.Loading.show('获取数据中...')
      $.ajax({
        method: 'get',
        url: '/api/v1/app/versions?uuid=' + that.record.app_uuid,
        contentType: 'application/json',
        data: {page: page, page_size: 100}
      }).done(function(res, status, xhr) {
        that.versions = res.data

      }).fail(function(res, status, xhr) {
      }).always(function(res, status, xhr) {
        window.Loading.hide()
      });
    },
    getAppLatestVersion(callback) {
      let that = this
      window.Loading.show('获取数据中...')
      $.ajax({
        method: 'get',
        url: '/api/v1/app/latest_version?uuid=' + that.app.latest_version_uuid,
        contentType: 'application/json'
      }).done(function(res, status, xhr) {
        window.Loading.hide()
        if(res.code == 200) {
          that.latest_version = res.data
          that.app.latest_version = res.data
        } else {
          window.Loading.popup(res.message)
        }
        callback()
      }).fail(function(res, status, xhr) {
      }).always(function(res, status, xhr) {
        window.Loading.hide()
      });
    },
    renderCommand(isPopup) {
      if(!this.record.command) {
        if(isPopup) { window.Loading.popup("请选择部署模板") }
        console.log('WARNING: 请选择部署模板')
        return false;
      }

      let that = this
      let command = that.record.command,
          matchDatas = command.match(/\{\{(.*?)\}\}/g) || [],
          varObjs = {},
          klassObj = {},
          varText, klass, obj, parts, result;

      if(!matchDatas.length) {
        console.log('INFO:  部署模板脚本中无变量')
        return false
      }

      klassObj = matchDatas.reduce((result, data) => {
        varText = data.replace(/\{|\}|\s/g, '')
        result[varText] = true
        result[varText.split('.')[0]] = true
        if(varText.indexOf('app.latest_version') == 0) { result['app.latest_version'] = true }
        return result
      }, {})

      if(klassObj['app'] && !that.app) {
        if(isPopup) { window.Loading.popup("请选择应用") }
        console.log('WARNING: 请选择应用')
        return false;
      }
      if(klassObj['version'] && !that.version) {
        if(isPopup) { window.Loading.popup("请选择应用版本") }
        console.log('WARNING: 请选择应用版本')
        return false;
      }

      try {
        let callback = () => {
          matchDatas.forEach((data) => {
            varText = data.replace(/\{|\}|\s/g, '')
            if(!varObjs[varText]) {
              parts = varText.split('.')
              klass = parts.splice(0, 1)[0]
              obj = (klass == 'app' ? that.app : that.version)
              parts.forEach((part, inx) => {
                obj = obj[part] 
              })
              varObjs[varText] = obj
              command = command.replace(new RegExp(data, 'g'), JSON.stringify(obj))
            }
            console.log(varText + ':', varObjs[varText])
          })
          that.record.command = command
        }
        if(klassObj['app.latest_version']) {
          if(!that.app.latest_version_uuid) {
            window.Loading.popup('应用关联的最新版本为空')
            return false
          }
          that.getAppLatestVersion(callback)
        } else {
          callback()
        }
      } catch(e) {
        console.log('渲染部署脚本异常:', e)
      }
    }
  }
})
</script>