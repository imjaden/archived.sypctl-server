%ol.breadcrumb
  %li 设备中心
  %li= link_to "主机管理", url_for('/') + "?page=#{params[:page] || 1}"
  %li
    %a{href: "#{url_for('/new')}?page=#{params[:page] || 1}"}
      新建主机
      %span.glyphicon.glyphicon-plus

:css   
  .devices th:nth-child(n+1), .devices td:nth-child(n+1) { text-align: center; width: 5%; }
  .devices th:nth-child(1), .devices td:nth-child(1) { width: 12%; }
  .devices th:nth-child(2), .devices td:nth-child(2) { text-align: left; width: 15%; }
  .devices th:nth-child(5), .devices td:nth-child(5) { width: 8%; }
  .devices th:nth-child(7), .devices td:nth-child(7) { width: 7%; }
  .devices th:nth-last-child(1), .devices td:nth-last-child(1) { text-align: center; width: 8%; }
%table.table.table-hover.table-condensed.table-strip.table-bordered.smart-table.devices
  %thead
    %th 分组名称
    %th 主机名称
    %th 系统类型
    %th 代理状态
    %th 最近提交
    %th 记录数量
    %th SSH 状态
    %th 创建任务
    %th 编辑
    %th 删除
    %th 创建时间
  %tbody
    - @records.each do |record|
      %tr{id: "dom_#{record.id}"}
        %td
          %span.label.label-default= link_to record.device_group.name, "/dashboard/#{record.device_group.uuid}", style: "color:white;" if record.device_group
        %td.name= link_to record.human_name || record.hostname, url_for("/#{record.id}")
        %td= "#{record.os_type}#{record.os_version}"
        %td
          - interval = (Time.now.to_i - record.updated_at.to_i) < 600
          %span.label{class: "#{interval ? 'label-success' : 'label-danger'}"}
            = interval ? '正常' : '异常'
        %td= record.updated_at.strftime('%y/%m/%d %H:%M')
        %td= link_to record.record_count, url_for("/#{record.id}/records"), class: "badge"
        %td
          %span.label{class: "label-#{record.ssh_state ? 'success' : 'warning'}"}
            = record.ssh_state ? '启用' : '关闭'
        %td
          %a{href: url_for("/#{record.id}/create_job")}
            %span.glyphicon.glyphicon-refresh
        %td
          %a{href: url_for("/#{record.id}/edit"), class: 'btn btn-xs btn-link'}
            %span.glyphicon.glyphicon-edit
        %td
          %a.btn.btn-xs.btn-link{style: "color: red;", onclick: "window.Device.remove(#{record.id});"}
            .span.glyphicon.glyphicon-trash
        %td= record.created_at.strftime('%y/%m/%d %H:%M')

= will_paginater @records

:javascript
  (function() {
      window.Device = {
        remove: function(id) {
          var name = $("#dom_" + id + " .name").text();

          if(!confirm('确定删除「' + name + '」?')) {
            return false;
          }

          window.Loading.show("删除中...");
          $.ajax({
            type: 'delete',
            url: "#{url_for('/')}" + id
          }).done(function(res, status, xhr) {
            if(res.code === 201) {
              $("#dom_" + id).remove();
              window.Loading.show("删除成功");

              try {
                var objects = {device: { id: id, name: name }}
                window.OperationLogger.record("device.delete", objects);
              } catch(e) { console.log(e) }
            } else {
              window.Loading.show("删除失败");
            }
          }).fail(function(xhr, status, error) {
              window.Loading.show("删除失败");
          }).always(function(res, status, xhr) {
              window.Loading.hide();
          });
        }
      }
  }).call(this);